name: SISR Build Base

on:
    workflow_call:
        inputs:
            artifact_suffix:
                required: false
                type: string
                default: ""
                description: "Suffix to add to artifact names"
            upload_artifacts:
                required: false
                type: boolean
                default: false
                description: "Whether to upload build artifacts"

jobs:
    test:
        name: Test
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, windows-latest]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Cache Rust dependencies
              uses: Swatinem/rust-cache@v2

            - name: Install build dependencies (Ubuntu)
              if: matrix.os == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y ninja-build cmake pkg-config libgtk-3-dev

            - name: Install build tools (Windows)
              if: matrix.os == 'windows-latest'
              shell: pwsh
              run: |
                  choco install ninja cmake -y
                  ninja --version
                  cmake --version

            - name: Run tests
              run: cargo test --all-features

    build:
        name: Build binaries (${{ matrix.target.name }})
        runs-on: ${{ matrix.target.os }}
        needs: test
        strategy:
            fail-fast: false
            matrix:
                target:
                    - {
                          name: "x86_64-pc-windows-msvc",
                          os: "windows-latest",
                          ext: ".exe",
                          rust_target: "x86_64-pc-windows-msvc",
                          cross: false,
                      }
                    - {
                          name: "aarch64-pc-windows-msvc",
                          os: "windows-latest",
                          ext: ".exe",
                          rust_target: "aarch64-pc-windows-msvc",
                          cross: true,
                      }
                    - {
                          name: "x86_64-unknown-linux-gnu",
                          os: "ubuntu-latest",
                          ext: "",
                          rust_target: "x86_64-unknown-linux-gnu",
                          cross: false,
                      }
                    - {
                          name: "aarch64-unknown-linux-gnu",
                          os: "ubuntu-latest",
                          ext: "",
                          rust_target: "aarch64-unknown-linux-gnu",
                          cross: true,
                      }
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target.rust_target }}

            - name: Cache Rust dependencies
              uses: Swatinem/rust-cache@v2
              with:
                  key: ${{ matrix.target.rust_target }}

            - name: Install build dependencies (Ubuntu)
              if: matrix.target.os == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y ninja-build cmake pkg-config libgtk-3-dev

            - name: Install cross-compilation tools (Linux ARM64)
              if: matrix.target.rust_target == 'aarch64-unknown-linux-gnu'
              run: |
                  sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

            - name: Install build tools (Windows)
              if: matrix.target.os == 'windows-latest'
              shell: pwsh
              run: |
                  choco install ninja cmake -y
                  ninja --version
                  cmake --version

            - name: Calculate version
              id: version
              shell: bash
              run: |
                  VERSION=$(git describe --tags --match "v[0-9]*.[0-9]*.[0-9]*" --always || echo "v0.0.0-dev")
                  git fetch --tags --force || true
                  if ! echo "$VERSION" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+'; then
                    COMMIT_COUNT=$(git rev-list --count HEAD)
                    VERSION="v0.0.0-${COMMIT_COUNT}-${GITHUB_SHA:0:7}"
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Version: $VERSION"

            - name: Build
              shell: bash
              env:
                  SISR_VERSION: ${{ steps.version.outputs.version }}
                  CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
              run: |
                  mkdir -p dist/package
                  cargo build --release --target ${{ matrix.target.rust_target }}

                  cp target/${{ matrix.target.rust_target }}/release/SISR${{ matrix.target.ext }} dist/package/SISR${{ matrix.target.ext }}

                  if [ "${{ matrix.target.os }}" = "windows-latest" ]; then
                    SDL3_DLL=$(find target/${{ matrix.target.rust_target }}/release/build/sdl3-sys-*/out/build -name "SDL3.dll" | head -1)
                    if [ -f "$SDL3_DLL" ]; then
                      cp "$SDL3_DLL" dist/package/
                      echo "Copied SDL3.dll"
                    else
                      echo "Warning: SDL3.dll not found"
                    fi
                  else
                    SDL3_SO=$(find target/${{ matrix.target.rust_target }}/release/build/sdl3-sys-*/out/build -name "libSDL3.so*" | head -1)
                    if [ -f "$SDL3_SO" ]; then
                      cp -P "$SDL3_SO"* dist/package/ 2>/dev/null || cp "$SDL3_SO" dist/package/
                      echo "Copied SDL3 library"
                    else
                      echo "Warning: SDL3 library not found"
                    fi
                  fi

                  ls -la dist/package

            - name: Create archive
              shell: bash
              run: |
                  cd dist/package
                  if [ "${{ matrix.target.os }}" = "windows-latest" ]; then
                    7z a ../sisr-${{ matrix.target.name }}.zip *
                  else
                    tar -czf ../sisr-${{ matrix.target.name }}.tar.gz *
                  fi
                  cd ../..
                  ls -la dist

            - name: Upload artifact
              if: ${{ inputs.upload_artifacts }}
              uses: actions/upload-artifact@v4
              with:
                  name: SISR-${{ matrix.target.name }}${{ inputs.artifact_suffix }}
                  path: dist/sisr-${{ matrix.target.name }}.*
                  if-no-files-found: error
